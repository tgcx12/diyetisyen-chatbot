Tamam â€” senin mevcut motor mantÄ±ÄŸÄ±nÄ± (Ã¶ÄŸÃ¼n ÅŸablonlarÄ± + pick_best + gÃ¼n sonu enerji ayarÄ±) **LLMâ€™e â€œpromptâ€ olarak doÄŸru aktarmanÄ±n** en iyi yolu ÅŸu:

1. **LLMâ€™den â€œyemek seÃ§imi + porsiyon Ã§arpanÄ±â€ iste** (planlayÄ±cÄ± rolÃ¼)
2. **KurallarÄ±n enforcement / validasyon / kalori tutturmayÄ±** yine senin deterministic motorun yapsÄ±n (hakem rolÃ¼)

Ã‡Ã¼nkÃ¼ besin havuzun zaten Ã§ok zengin etiket/Ã¶ÄŸÃ¼n/kategori iÃ§eriyor ve â€œicat etmesinâ€ diye LLMâ€™i sÄ±kÄ± bir ÅŸemaya kilitlemek gerekiyor.

AÅŸaÄŸÄ±da sana **kopyala-yapÄ±ÅŸtÄ±r prompt ÅŸablonu** + **hangi alanlarÄ± besin havuzundan eklemen gerektiÄŸi** + **LLMâ€™e kalori tutturmayÄ± nasÄ±l tarif edeceÄŸin** var.

---

## 1) Besin havuzu ÅŸemanÄ± LLMâ€™e nasÄ±l anlatmalÄ±sÄ±n?

Senin `besin` Ã¶ÄŸelerin (her item) kabaca ÅŸu alanlara sahip: `besin_id`, `besin_adi`, `kategori`, `ogun` (liste), `miktar`, `kcal`, `food_tags`, `avoid_tags`, `besin_degerleri`. 

AyrÄ±ca havuzun `meta` kÄ±smÄ±nda porsiyon standartlarÄ± ve â€œÃ¶ÄŸÃ¼n seviye kural ipuÃ§larÄ±â€ var (ekmek+pilav aynÄ± Ã¶ÄŸÃ¼nde olmasÄ±n gibi). 

ğŸ‘‰ LLMâ€™e **tam DBâ€™yi** basmak yerine her Ã¶ÄŸÃ¼n iÃ§in **kandidate set** Ã¼retip basman Ã§ok daha iyi (token + kalite).

**Ã–neri:**

* â€œSabahâ€ iÃ§in `ogun` iÃ§inde `"sabah"` geÃ§enleri,
* â€œAra Ã–ÄŸÃ¼nâ€ iÃ§in `"ara_1"/"ara_2"/"ara"` geÃ§enleri,
* â€œÃ–ÄŸle/AkÅŸamâ€ iÃ§in ilgili Ã¶ÄŸÃ¼n tokenâ€™Ä±nÄ± geÃ§enleri,
* plus: senin motorun yaptÄ±ÄŸÄ± gibi kategori/tag whitelistâ€™leri ile daralt.

---

## 2) LLM Ã§Ä±ktÄ±sÄ±nÄ± kilitle: sadece ID + porsiyon Ã§arpanÄ±

Sen zaten `_portion_mult` ve `_portion_lock` mantÄ±ÄŸÄ±nÄ± kullanÄ±yorsun (gÃ¼n sonu Ã¶lÃ§ekleme ve/veya rule-based adjust). Bu yÃ¼zden LLMâ€™den ÅŸu formatÄ± iste:

* Her Ã¶ÄŸÃ¼n: seÃ§ilen itemâ€™lar
* Her item: `besin_id` + `portion_mult` (Ã¶rn 1.0, 0.5, 1.5)
* Asla yeni besin ismi Ã¼retme
* Asla havuz dÄ±ÅŸÄ± ID kullanma

---

## 3) â€œKalori tutturmaâ€yÄ± LLMâ€™e nasÄ±l tarif etmelisin?

Senin yaklaÅŸÄ±mÄ±n iki katman:

* **Ã–ÄŸÃ¼n inÅŸasÄ±**: ÅŸablon (kahvaltÄ±: tahÄ±l+protein+sebzeâ€¦)
* **GÃ¼n sonu enerji ayarÄ±**: hedefe gÃ¶re porsiyon artÄ±r/azalt veya ekle/Ã§Ä±kar (sen bunu `day_end_adjust_by_energy_rules` ile yapÄ±yorsun). 

LLM tarafÄ±nda bunu ÅŸÃ¶yle yaptÄ±rabilirsin:

### A) â€œLLM sadece taslak plan Ã¼retirâ€

Kalori tutmazsa sorun deÄŸil â†’ senin motor ayarlar.

### B) â€œLLM taslak + dÃ¼zeltme adÄ±mÄ± Ã¼retirâ€

LLM Ã¶nce taslaÄŸÄ± Ã¼retir, sonra `delta = hedef - mevcut` ise â€œhangi Ã¶ÄŸÃ¼nde hangi aksiyon yapÄ±lmalÄ±â€ diye **1â€“3 adÄ±m** Ã¶nerir:

* increase_portion (scalable veya ekmek/meyve/kuruyemiÅŸ gibi)
* decrease_portion
* add (yoÄŸurt/meyve/kuruyemiÅŸ gibi tek kalem)
  Bu yaklaÅŸÄ±m, senin energy band/step stratejine Ã§ok benzer.

---

## 4) Kopyala-yapÄ±ÅŸtÄ±r: SYSTEM prompt (sabit)

AÅŸaÄŸÄ±daki SYSTEM promptâ€™u bir kere yaz, her istekte kullan:

```text
Sen bir â€œdiyet planlayÄ±cÄ±â€sÄ±n. Sana verilen BESÄ°N HAVUZU iÃ§inden seÃ§im yaparak 1 gÃ¼nlÃ¼k menÃ¼ oluÅŸturacaksÄ±n.

SERT KURALLAR:
- SADECE verilen besin_idâ€™leri kullan. Asla yeni besin Ã¼retme, isim uydurma.
- Ã‡Ä±ktÄ± mutlaka JSON olacak ve ÅŸemaya uyacak.
- Her seÃ§ilen item iÃ§in portion_mult (0.5 / 1.0 / 1.5 / 2.0 gibi) ver.
- food_tags ve avoid_tags kÄ±sÄ±tlarÄ±na uy. Avoid listesinde olan bir etiketi taÅŸÄ±yan besini seÃ§me.
- Ã–ÄŸÃ¼n eÅŸleÅŸmesi: Bir besin sadece kendi ogun alanÄ±nda bulunan Ã¶ÄŸÃ¼nlerde seÃ§ilebilir.
- Ã–ÄŸÃ¼n iÃ§i Ã§akÄ±ÅŸma ipuÃ§larÄ±: AynÄ± Ã¶ÄŸÃ¼nde ekmek ile pilav/makarna veya baklagil_yemegi birlikte seÃ§ilmemeli (kural ipucu).
- AmaÃ§: GÃ¼nlÃ¼k hedef kaloriye mÃ¼mkÃ¼n olduÄŸunca yaklaÅŸ (Â±50 kcal tolerans). Tutturamazsan â€œadjust_stepsâ€ alanÄ±nda 1â€“3 dÃ¼zeltme Ã¶ner.

Ã–ÄÃœN ÅABLONLARI (Ã¶zet):
- Sabah: 1 tahÄ±l/ekmek + 1 protein/sÃ¼t Ã¼rÃ¼nÃ¼ + 1â€“2 sebze/yeÅŸillik (+ dÃ¼ÅŸÃ¼k kalÄ±rsa ekstra tahÄ±l veya sÃ¼t Ã¼rÃ¼nÃ¼).
- Ara Ã–ÄŸÃ¼n: tek seÃ§im (meyve veya kuruyemiÅŸ veya sÃ¼t Ã¼rÃ¼nÃ¼ veya â€œkombinâ€ tek kalem).
- Ã–ÄŸle/AkÅŸam: 1 ana yemek (balÄ±k/beyaz_et/kirmizi_et/baklagil_yemegi/sebze_yemegi) + opsiyonel Ã§orba + tek yan (salata veya yoÄŸurt/cacÄ±k; balÄ±kta salata tercih) + (uygunsa) tam tahÄ±llÄ± ekmek.
- Yatarken: tek kalem sÃ¼t/sÃ¼t Ã¼rÃ¼nÃ¼.

Ã‡IKTI ÅEMASI (JSON):
{
  "kcal_target": int,
  "meals": {
    "Sabah": [{"besin_id": "...", "portion_mult": 1.0}],
    "Ara Ã–ÄŸÃ¼n 1": [...],
    "Ã–ÄŸle": [...],
    "Ara Ã–ÄŸÃ¼n 2": [...],
    "AkÅŸam": [...],
    "Yatarken": [...]
  },
  "kcal_estimate": int,
  "adjust_steps": [
    {"action":"increase_portion|decrease_portion|add|replace", "meal":"...", "target_tags_any":["..."], "note":"..."}
  ],
  "notes": ["kÄ±sa notlar"]
}
```

Bu prompt, senin havuz metaâ€™sÄ±ndaki â€œmeal_level_rules_hintsâ€ mantÄ±ÄŸÄ±yla uyumlu. 

---

## 5) Kopyala-yapÄ±ÅŸtÄ±r: USER prompt (her Ã§aÄŸrÄ±da dinamik)

Bunu her kullanÄ±cÄ± iÃ§in dolduracaksÄ±n. Burada **Mifflin + %15 aÃ§Ä±k** hesaplarÄ±nÄ± da net ver:

```text
KULLANICI PROFÄ°LÄ°
- Cinsiyet: {male|female}
- YaÅŸ: {age}
- Boy: {cm}
- Kilo: {kg}
- Aktivite katsayÄ±sÄ±: {1.2|1.375|1.55|1.725|1.9}
- AmaÃ§: yaÄŸ kaybÄ±
- FormÃ¼l: Mifflin-St Jeor ile BMR, sonra TDEE = BMR*aktivite
- Kalori aÃ§Ä±ÄŸÄ±: %15
- GÃ¼nlÃ¼k hedef kcal: {kcal_target}  (bu deÄŸeri kullan)

KISITLAR
- prefer_tags (varsa): {["...","..."]}
- avoid_tags (hastalÄ±k/alerji/ilaÃ§ vb.): {["...","..."]}

Ã–ÄÃœN KALORÄ° DAÄILIMI
- Sabah: %25
- Ara Ã–ÄŸÃ¼n 1: %10
- Ã–ÄŸle: %25
- Ara Ã–ÄŸÃ¼n 2: %10
- AkÅŸam: %20
- Yatarken: %10

BESÄ°N HAVUZU (sadece bu listeden seÃ§)
- Sabah adaylarÄ±: { ... kÄ±sa liste ... }
- Ara Ã¶ÄŸÃ¼n adaylarÄ±: { ... kÄ±sa liste ... }
- Ã–ÄŸle adaylarÄ±: { ... kÄ±sa liste ... }
- AkÅŸam adaylarÄ±: { ... kÄ±sa liste ... }
- Yatarken adaylarÄ±: { ... kÄ±sa liste ... }

Not: Her aday Ã¶ÄŸe ÅŸu alanlara sahiptir: besin_id, besin_adi, kategori, kcal, miktar, ogun, food_tags, avoid_tags.
Sadece besin_id ve portion_mult ile Ã§Ä±ktÄ± Ã¼ret.
```

Besin adaylarÄ±nÄ± â€œkÄ±sa listeâ€ derken: her item iÃ§in ÅŸu kadar bilgi yeter:

* `besin_id`, `besin_adi`, `kcal`, `food_tags` (ve gerekiyorsa `kategori`)
  Ã‡Ã¼nkÃ¼ senin havuzda bu alanlar zaten var. 

---

## 6) Pratik entegrasyon: â€œkandidat havuzâ€ nasÄ±l hazÄ±rlanÄ±r?

Senin motorun zaten `food_in_meal(...)` gibi normalize edip Ã¶ÄŸÃ¼n eÅŸliyor. 
LLM iÃ§in de aynÄ± yaklaÅŸÄ±m:

* `candidates_breakfast = foods.filter(ogun includes "sabah")`
* `candidates_snack = foods.filter(ogun includes "ara_1"/"ara_2"/"ara")`
* `candidates_lunch = foods.filter(ogun includes "Ã¶ÄŸle")`
* `candidates_dinner = foods.filter(ogun includes "akÅŸam")`
* `candidates_sleep = foods.filter(ogun includes "yatarken")`

Sonra her Ã¶ÄŸÃ¼n listesinde:

* avoid_tagsâ€™e Ã§arpÄ±ÅŸanlarÄ± Ã§Ä±kar
* â€œyuksek_kaloriâ€ gibi istemediklerin varsa ayrÄ±ca Ã§Ä±kar (sen zaten item bazÄ±nda `avoid_tags` tutuyorsun) 

---

## 7) En saÄŸlam mimari: LLM = â€œtaslakâ€, motor = â€œhakemâ€

**Ã–nerdiÄŸim akÄ±ÅŸ:**

1. LLM â†’ taslak menÃ¼ (ID + portion_mult)
2. Senin kod â†’ doÄŸrula / eksik Ã¶ÄŸÃ¼nleri doldur / illegal kombinasyonlarÄ± dÃ¼zelt
3. Senin `day_end_adjust_by_energy_rules` â†’ hedefe yaklaÅŸtÄ±r 
4. En sonda raporla

Bu ÅŸekilde LLM â€œkural motoruâ€ olmak zorunda kalmaz; senin deterministic sistemin her zaman son sÃ¶zÃ¼ sÃ¶yler.

---

Ä°stersen bir sonraki adÄ±m olarak ben:

* senin `besin_havuzu_eski.normalized.json` iÃ§inden **Ã¶rnek 1 gÃ¼nlÃ¼k aday paket** Ã§Ä±karÄ±p,
* yukarÄ±daki USER prompt formatÄ±nda **gerÃ§ek doldurulmuÅŸ** bir prompt Ã¶rneÄŸi yazayÄ±m (kÄ±sa ama Ã§alÄ±ÅŸÄ±r).

Bunun iÃ§in sadece â€œÃ¶rnek bir kullanÄ±cÄ± profiliâ€ (yaÅŸ/boy/kilo/cinsiyet/aktivite) ver; ben doÄŸrudan Ã§alÄ±ÅŸÄ±r Ã¶rneÄŸi Ã¼reteyim.
